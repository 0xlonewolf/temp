Import-Module ActiveDirectory ; Import-Module GroupPolicy ; $OutputDir = "Manual-ADPA-Output" ; if (-not (Test-Path $OutputDir)) {New-Item -Path $OutputDir -ItemType Directory -Force | Out-Null }

Get-ADForest | Export-Csv -Path "$OutputDir\S101-Forest-Information.csv" -NoTypeInformation

# S102 - Domain Information  
Get-ADDomain | Export-Csv -Path "$OutputDir\S102-Domain-Information.csv" -NoTypeInformation

# S103 - Trust Information
Get-ADTrust -Filter * | Export-Csv -Path "$OutputDir\S103-Trust-Information.csv" -NoTypeInformation

# S127 - DCSync Rights Detection
Get-ADUser -Filter * -Properties sAMAccountName, displayName, userAccountControl | Where-Object { ($_.userAccountControl -band 524288) -eq 524288 } | Export-Csv -Path "$OutputDir\S127-DCSync-Rights-Detection.csv" -NoTypeInformation

# S128 - Dangerous ACLs Detection
Get-Acl -Path "AD:$((Get-ADDomain).DistinguishedName)" | Export-Csv -Path "$OutputDir\S128-Dangerous-ACLs-Detection.csv" -NoTypeInformation

# S129 - Kerberos Vulnerabilities
Get-ADUser -Filter * -Properties sAMAccountName, displayName, userAccountControl | Where-Object { ($_.userAccountControl -band 4194304) -eq 4194304 -and ($_.userAccountControl -band 2) -eq 0 } | Export-Csv -Path "$OutputDir\S129-Kerberos-Vulnerabilities.csv" -NoTypeInformation

# S130 - SID History Abuse
Get-ADUser -Filter * -Properties sAMAccountName, displayName, sIDHistory | Where-Object { $_.sIDHistory -ne $null -and $_.sIDHistory.Count -gt 0 } | Export-Csv -Path "$OutputDir\S130-SIDHistory-Abuse-Detection.csv" -NoTypeInformation

# S131 - Service Account Security
Get-ADUser -Filter * -Properties sAMAccountName, displayName, servicePrincipalName, userAccountControl | Where-Object { $_.servicePrincipalName -ne $null -and ($_.userAccountControl -band 65536) -eq 65536 } | Export-Csv -Path "$OutputDir\S131-Service-Account-Security.csv" -NoTypeInformation

# S140 - Enhanced Password Policy
Get-ADDefaultDomainPasswordPolicy | Export-Csv -Path "$OutputDir\S140-Enhanced-Password-Policy.csv" -NoTypeInformation

# S141 - CIS Password Policy Compliance
Get-ADDefaultDomainPasswordPolicy -ErrorAction Stop | Export-Csv -Path "$OutputDir\S141-CIS-Password-Policy-Compliance.csv" -NoTypeInformation

# S142 - CIS Account Lockout Policy
Get-ADDefaultDomainPasswordPolicy -ErrorAction Stop | Export-Csv -Path "$OutputDir\S142-CIS-Account-Lockout-Policy-Compliance.csv" -NoTypeInformation

# S143 - Privileged Group Analysis
Get-ADGroupMember -Identity "Domain Admins" -Recursive | Export-Csv -Path "$OutputDir\S143-Privileged-Group-Analysis.csv" -NoTypeInformation

# S144 - Enhanced Delegation Security
Get-ADUser -Filter * -Properties sAMAccountName, displayName, userAccountControl, enabled, lastLogonDate, servicePrincipalNames, memberOf | Where-Object { ($_.userAccountControl -band 524288) -eq 524288 } | Export-Csv -Path "$OutputDir\S144-Enhanced-Delegation-Security.csv" -NoTypeInformation

# S145 - CIS User Rights Assignment
Get-GPO -All | Export-Csv -Path "$OutputDir\S145-CIS-User-Rights-Assignment-Compliance.csv" -NoTypeInformation

# S146 - Comprehensive CIS Compliance
Get-GPO -All | Export-Csv -Path "$OutputDir\S146-Comprehensive-CIS-Compliance.csv" -NoTypeInformation

# S147 - CIS Security Options
Get-GPO -All | Export-Csv -Path "$OutputDir\S147-CIS-Security-Options-Compliance.csv" -NoTypeInformation

# S148 - GPO Security Analysis
Get-GPO -All -ErrorAction Stop | Export-Csv -Path "$OutputDir\S148-GPO-Security-Analysis.csv" -NoTypeInformation

# S149 - Group Permission Risk Analysis
Get-ADGroup -Filter * -Properties member, memberOf -ErrorAction Stop | Export-Csv -Path "$OutputDir\S149-Group-Permission-Risk-Analysis.csv" -NoTypeInformation

# S150 - Service Principal Name Security
Get-ADUser -Filter "servicePrincipalName -like '*'" -Properties sAMAccountName, displayName, servicePrincipalName, userAccountControl, enabled, lastLogonDate, memberOf | Export-Csv -Path "$OutputDir\S150-Service-Principal-Name-Security.csv" -NoTypeInformation

# S151 - KRBTGT Account Security
Get-ADUser -Identity "krbtgt" -Properties sAMAccountName, displayName, userAccountControl, enabled, lastLogonDate, pwdLastSet, whenChanged, whenCreated, memberOf | Export-Csv -Path "$OutputDir\S151-KRBTGT-Account-Security.csv" -NoTypeInformation

# S152 - OS Lifecycle Management
Get-ADComputer -Filter * -Properties name, operatingSystem, operatingSystemVersion, operatingSystemServicePack, lastLogonDate, enabled | Export-Csv -Path "$OutputDir\S152-OS-Lifecycle-Management.csv" -NoTypeInformation

# S153 - Rapid Threat Assessment
Get-ADUser -Filter * -Properties pwdLastSet, whenChanged, lastLogonDate, userAccountControl, enabled | Export-Csv -Path "$OutputDir\S153-Rapid-Threat-Assessment.csv" -NoTypeInformation

# S154 - Incident Response Reports
Get-ADObject -Filter * -Properties whenChanged, whenCreated, objectClass | Export-Csv -Path "$OutputDir\S154-Incident-Response-Reports.csv" -NoTypeInformation

# S155 - Containment Verification
Get-ADUser -Filter * -Properties sAMAccountName, displayName, userAccountControl, enabled, lockoutTime, pwdLastSet, lastLogonDate | Export-Csv -Path "$OutputDir\S155-Containment-Verification.csv" -NoTypeInformation

# S156 - Post Incident Analysis
Get-ADUser -Filter * -Properties sAMAccountName, displayName, userAccountControl, enabled, lastLogonDate, pwdLastSet | Export-Csv -Path "$OutputDir\S156-Post-Incident-Analysis.csv" -NoTypeInformation

# S157 - Behavioral Analysis
Get-ADUser -Filter "lastLogonDate -lt '$((Get-Date).AddDays(-90).ToString('yyyy-MM-dd'))'" | Export-Csv -Path "$OutputDir\S157-Behavioral-Analysis.csv" -NoTypeInformation

# S158 - Suspicious Patterns
Get-ADUser -Filter "sAMAccountName -like '*admin*'" -Properties sAMAccountName, displayName, userAccountControl, whenCreated | Export-Csv -Path "$OutputDir\S158-Suspicious-Patterns.csv" -NoTypeInformation

# S159 - Threat Intelligence Summary
Get-ADForest; Get-ADTrust -Filter * | Export-Csv -Path "$OutputDir\S159-Threat-Intelligence-Summary.csv" -NoTypeInformation
